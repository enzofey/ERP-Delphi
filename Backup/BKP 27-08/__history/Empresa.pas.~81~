unit Empresa;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.ExtCtrls, Vcl.StdCtrls, Vcl.Buttons, Vcl.ComCtrls,
  CEPDataModule, ConsultarCEPForm,
  EmpresaDataModule,
  Log, LogDataModule,
  GlobalUnit, Vcl.Mask;

type
  TCadEmpresa = class(TForm)
    Panel1: TPanel;
    lblRazaoSocial: TLabel;
    lblCNPJ: TLabel;
    lblIE: TLabel;
    lblBairro: TLabel;
    lblRua: TLabel;
    LblPais: TLabel;
    LblCEP: TLabel;
    LblCidade: TLabel;
    LblComplemento: TLabel;
    lblNumero: TLabel;
    LblEstado: TLabel;
    EdtEstado: TEdit;
    EdtCidade: TEdit;
    EdtComplemento: TEdit;
    EdtNumero: TEdit;
    EdtRua: TEdit;
    EdtPais: TEdit;
    SBCEP: TSpeedButton;
    EdtBairro: TEdit;
    EdtRazaoSocial: TEdit;
    btnAlterar: TButton;
    BtnDesistir: TButton;
    btnFechar: TButton;
    BtnGravarAlterar: TButton;
    BtnGravarIncluir: TButton;
    btnIncluir: TButton;
    lblEmpID: TLabel;
    edtEmp_ID: TEdit;
    lblSerie: TLabel;
    edtSerie: TEdit;
    GBBCRT: TGroupBox;
    CBRegime: TComboBox;
    EdtCEP: TEdit;
    EdtCNPJ: TEdit;
    EdtIE: TEdit;
    lblFantasia: TLabel;
    EdtFantasia: TEdit;
    lblTelefone: TLabel;
    EdtTelefone: TEdit;
    procedure SBCEPClick(Sender: TObject);
    procedure btnIncluirClick(Sender: TObject);
    procedure BtnDesistirClick(Sender: TObject);
    procedure BtnGravarIncluirClick(Sender: TObject);
    procedure FormShow(Sender: TObject);
    procedure btnFecharClick(Sender: TObject);
    procedure btnAlterarClick(Sender: TObject);
    procedure BtnGravarAlterarClick(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
  end;

var
  CadEmpresa: TCadEmpresa;

implementation

{$R *.dfm}

procedure TCadEmpresa.FormShow(Sender: TObject);
var nome, cnpj, IE, rua, numero, estado, bairro, cidade, pais, complemento, cep, serie, EMP_ID, CRT, Telefone, Fantasia: string;
begin
  CadEmpresaDataModule.SelectQuery.SQL.Clear;
  CadEmpresaDataModule.SelectQuery.Close;
  CadEmpresaDataModule.SelectQuery.SQL.Text :=
  'select * from empresa where emp_id = :emp_id';
  CadEmpresaDataModule.SelectQuery.ParamByName('EMP_ID').AsString := empresalogada;
  CadEmpresaDataModule.SelectQuery.Open;

  nome := CadEmpresaDataModule.SelectQuery.FieldByName('nome').AsString;
  CNPJ := CadEmpresaDataModule.SelectQuery.FieldByName('CNPJ').AsString;
  IE := CadEmpresaDataModule.SelectQuery.FieldByName('IE').AsString;
  Rua := CadEmpresaDataModule.SelectQuery.FieldByName('Rua').AsString;
  Numero := CadEmpresaDataModule.SelectQuery.FieldByName('Numero').AsString;
  Estado := CadEmpresaDataModule.SelectQuery.FieldByName('Estado').AsString;
  Bairro := CadEmpresaDataModule.SelectQuery.FieldByName('Bairro').AsString;
  Cidade := CadEmpresaDataModule.SelectQuery.FieldByName('Cidade').AsString;
  Pais := CadEmpresaDataModule.SelectQuery.FieldByName('Pais').AsString;
  complemento := CadEmpresaDataModule.SelectQuery.FieldByName('complemento').AsString;
  CEP := CadEmpresaDataModule.SelectQuery.FieldByName('cep').AsString;
  serie := CadEmpresaDataModule.SelectQuery.FieldByName('serie').AsString;
  EMP_ID := CadEmpresaDataModule.SelectQuery.FieldByName('EMP_ID').AsString;
  CRT := CadEmpresaDataModule.SelectQuery.FieldByName('CRT').AsString;
  Fantasia := CadEmpresaDataModule.SelectQuery.FieldByName('Fantasia').AsString;
  Telefone := CadEmpresaDataModule.SelectQuery.FieldByName('Telefone').AsString;

  EdtTelefone.Text := telefone;
  EdtRazaoSocial.text := nome;
  EdtFantasia.Text := Fantasia;
  EdtCNPJ.Text := CNPJ;
  EdtIE.Text := IE;
  EdtRua.Text := Rua;
  EdtNumero.text := Numero;
  EdtEstado.Text := Estado;
  EdtBairro.text := Bairro;
  EdtCidade.Text := Cidade;
  EdtPais.Text := Pais;
  edtcomplemento.text := Complemento;
  edtcep.text := Cep;
  edtserie.text := Serie;
  EdtEMP_ID.Text := EmpresaLogada;
  if CRT = '1' then CBRegime.ItemIndex := CBRegime.Items.IndexOf('1 - Simples Nacional')
  else if CRT = '2' then CBRegime.ItemIndex := CBRegime.Items.IndexOf('2 - Simples Nacional, excesso sublimite')
  else if CRT = '3' then CBRegime.ItemIndex := CBRegime.Items.IndexOf('3 - Regime Normal');
end;

procedure TCadEmpresa.btnIncluirClick(Sender: TObject);
begin
 EdtRazaoSocial.Clear;
 EdtCNPJ.Clear;
 EdtIE.Clear;
 EdtRua.Clear;
 EdtNumero.Clear;
 EdtEstado.Clear;
 EdtBairro.Clear;
 EdtCidade.Clear;
 EdtPais.Clear;
 EdtComplemento.Clear;
 EdtCEP.Clear;
 EdtEMP_ID.Clear;
 EdtSerie.Clear;
 EdtFantasia.Clear;
 EdtTelefone.Clear;

 EdtTelefone.Enabled := True;
 EdtFantasia.Enabled := True;
 EdtRazaoSocial.Enabled := True;
 EdtCNPJ.Enabled := True;
 EdtIE.Enabled := True;
 EdtRua.Enabled := True;
 EdtNumero.Enabled := True;
 EdtBairro.Enabled := True;
 EdtComplemento.Enabled := True;
 EdtCEP.Enabled := True;
 edtserie.Enabled := True;
 EdtEMP_ID.Enabled := True;
 CBRegime.enabled := True;

 btnIncluir.Visible := False;
 btnAlterar.Visible := False;

 SBCEP.Enabled := True;
 btnGravarIncluir.Visible := True;
 btnDesistir.Visible := True;
end;

procedure TCadEmpresa.BtnGravarIncluirClick(Sender: TObject);
var nome, cnpj, IE, rua, numero, estado, bairro, cidade, pais, complemento, cep, serie, EMP_ID, CRT, Fantasia, telefone, tela: string;
    data: Tdatetime;
begin
  nome := EdtRazaoSocial.text;
  fantasia := EdtFantasia.Text;
  CNPJ := EdtCNPJ.Text;
  IE := EdtIE.Text;
  Rua := EdtRua.Text;
  Numero := EdtNumero.text;
  Estado := EdtEstado.Text;
  Bairro := EdtBairro.text;
  Cidade := EdtCidade.Text;
  Pais := EdtPais.Text;
  complemento := edtcomplemento.text;
  cep := edtcep.text;
  serie := edtserie.text;
  tela := 'CadEmpresa';
  data := Now;
  EMP_ID := EdtEMP_ID.Text;
  CRT := CBRegime.Text;
  telefone := EdtTelefone.Text;

  if EdtRazaoSocial.Text = '' then begin
  ShowMessage('Nome não pode ficar em branco!');
  end
  else begin

  if EdtFantasia.Text = '' then begin
  ShowMessage('Fantasia não pode ficar em branco!');
  end
  else begin

  if StringReplace(StringReplace(StringReplace(StringReplace(StringReplace(EdtCNPJ.Text, '.', '', [rfReplaceAll]), '/', '', [rfReplaceAll]), '-', '', [rfReplaceAll]), '_', '', [rfReplaceAll]), ' ', '', [rfReplaceAll]) = '' then begin
  ShowMessage('CNPJ não pode ficar em branco!');
  end
  else begin

  if StringReplace(StringReplace(StringReplace(StringReplace(EdtIE.Text, '.', '', [rfReplaceAll]), '-', '', [rfReplaceAll]), '_', '', [rfReplaceAll]), ' ', '', [rfReplaceAll]) = '' then begin
  ShowMessage('IE não pode ficar em branco!');
  end
  else begin

  if EdtEMP_ID.Text = '' then begin
  ShowMessage('EMP_ID não pode ficar em branco!');
  end
  else begin

  if EdtRua.Text = '' then begin
  ShowMessage('Rua não pode ficar em branco!');
  end
  else begin

  if EdtNumero.Text = '' then begin
  ShowMessage('Numero não pode ficar em branco!');
  end
  else begin

  if EdtEstado.Text = '' then begin
  ShowMessage('Estado não pode ficar em branco!');
  end
  else begin

  if EdtBairro.Text = '' then begin
  ShowMessage('Bairro não pode ficar em branco!');
  end
  else begin

  if EdtCidade.Text = '' then begin
  ShowMessage('Cidade não pode ficar em branco!');
  end
  else begin

  if EdtPais.Text = '' then begin
  ShowMessage('País não pode ficar em branco!');
  end
  else begin

  if Edtcomplemento.Text = '' then begin
  ShowMessage('Complemento não pode ficar em branco!');
  end
  else begin

  if EdtSerie.Text = '' then begin
  ShowMessage('Série não pode ficar em branco!');
  end
  else begin

  if EdtTelefone.Text = '' then begin
  ShowMessage('Telefone não pode ficar em branco!');
  end
  else begin

  if CBRegime.Text = '' then begin
  ShowMessage('Regime não selecionado!');
  end
  else begin

  CadEmpresaDataModule.InsertQuery.SQL.Clear;
  CadEmpresaDataModule.InsertQuery.SQL.Text :=
  'insert into empresa (nome, Fantasia, cnpj, IE, rua, numero, estado, bairro, cidade, pais, complemento, cep, serie, EMP_ID, CRT, Telefone) ' +
  'values ' +
  '(:nome, :Fantasia, :cnpj, :IE, :rua, :numero, :estado, :bairro, :cidade, :pais, :complemento, :cep, :serie, :EMP_ID, :CRT, :Telefone)';
  CadEmpresaDataModule.InsertQuery.ParamByName('nome').AsString := nome;
  CadEmpresaDataModule.InsertQuery.ParamByName('cnpj').AsString := cnpj;
  CadEmpresaDataModule.InsertQuery.ParamByName('IE').AsString := IE;
  CadEmpresaDataModule.InsertQuery.ParamByName('rua').AsString := rua;
  CadEmpresaDataModule.InsertQuery.ParamByName('numero').AsString := numero;
  CadEmpresaDataModule.InsertQuery.ParamByName('estado').AsString := estado;
  CadEmpresaDataModule.InsertQuery.ParamByName('bairro').AsString := bairro;
  CadEmpresaDataModule.InsertQuery.ParamByName('cidade').AsString := cidade;
  CadEmpresaDataModule.InsertQuery.ParamByName('pais').AsString := pais;
  CadEmpresaDataModule.InsertQuery.ParamByName('complemento').AsString := complemento;
  CadEmpresaDataModule.InsertQuery.ParamByName('cep').AsString := cep;
  CadEmpresaDataModule.InsertQuery.ParamByName('serie').AsString := serie;
  CadEmpresaDataModule.InsertQuery.ParamByName('EMP_ID').AsString := EMP_ID;
  CadEmpresaDataModule.InsertQuery.ParamByName('CRT').AsString := CRT;
  CadEmpresaDataModule.InsertQuery.ParamByName('Fantasia').AsString := Fantasia;
  CadEmpresaDataModule.InsertQuery.ParamByName('Telefone').AsString := Telefone;

  LogModule.InserirLog.SQL.Clear;
  LogModule.InserirLog.SQL.Text :=
  'insert into logs (descricao, data, tela, usuario, emp_id)' +
  'values ' +
  '(:descricao, :data, :tela, :usuario, :emp_id)';
  LogModule.InserirLog.ParamByName('descricao').AsString :=
  'Inseriu a empresa ' + nome + ' no CNPJ ' + CNPJ + ' na IE ' + IE + ' no CEP ' + CEP + ' na série ' + serie + ' e CRT ' + CRT;
  LogModule.InserirLog.ParamByName('data').AsDateTime := data;
  LogModule.InserirLog.ParamByName('tela').AsString := tela;
  LogModule.InserirLog.ParamByName('usuario').AsString := UsuarioLogado;
  LogModule.InserirLog.ParamByName('emp_id').AsString := EmpresaLogada;
  try
  LogModule.InserirLog.ExecSQL;
  CadEmpresaDataModule.InsertQuery.ExecSQL;
  showmessage('Gravado com sucesso');
  EdtRazaoSocial.Enabled := False;
  EdtFantasia.Enabled := False;
  EdtCNPJ.Enabled := False;
  EdtIE.Enabled := False;
  EdtRua.Enabled := False;
  EdtNumero.Enabled := False;
  EdtBairro.Enabled := False;
  EdtComplemento.Enabled := False;
  EdtCEP.Enabled := False;
  edtserie.Enabled := False;
  EdtEMP_ID.Enabled := False;
  EdtTelefone.Enabled := False;
  CBRegime.enabled := False;

  btnIncluir.Visible := True;
  btnAlterar.Visible := True;

  SBCEP.Enabled := False;
  btnGravarIncluir.Visible := False;
  btnDesistir.Visible := False;
  except
  showmessage('Erro na gravação');
  end;
end;
end;
end;
end;
end;
end;
end;
end;
end;
end;
end;
end;
end;
end;
end;
end;

procedure TCadEmpresa.btnAlterarClick(Sender: TObject);
begin
 IF EdtEMP_ID.Text = '' then begin
 ShowMessage('Nenhuma empresa selecionada, favor fechar e abrir a tela para recarregar as informações da empresa logada!');
 end
 else begin
 EdtRazaoSocial.Enabled := True;
 EdtTelefone.Enabled := True;
 EdtFantasia.Enabled := True;
 EdtCNPJ.Enabled := True;
 EdtIE.Enabled := True;
 EdtRua.Enabled := True;
 EdtNumero.Enabled := True;
 EdtBairro.Enabled := True;
 EdtComplemento.Enabled := True;
 EdtCEP.Enabled := True;
 edtserie.Enabled := True;
 CBRegime.Enabled := True;

 btnIncluir.Visible := False;
 btnAlterar.Visible := False;

 SBCEP.Enabled := True;
 btnGravarAlterar.Visible := True;
 btnDesistir.Visible := True;
end;
end;

procedure TCadEmpresa.BtnGravarAlterarClick(Sender: TObject);
var nome, cnpj, IE, rua, numero, estado, bairro, cidade, pais, complemento, cep, serie, EMP_ID, CRT, Fantasia, telefone, tela: string;
    data: Tdatetime;
begin
  nome := EdtRazaoSocial.text;
  CNPJ := EdtCNPJ.Text;
  IE := EdtIE.Text;
  Rua := EdtRua.Text;
  Numero := EdtNumero.text;
  Estado := EdtEstado.Text;
  Bairro := EdtBairro.text;
  Cidade := EdtCidade.Text;
  Pais := EdtPais.Text;
  complemento := edtcomplemento.text;
  cep := edtcep.text;
  serie := edtserie.text;
  tela := 'CadEmpresa';
  data := Now;
  EMP_ID := EdtEMP_ID.Text;
  CRT := CBRegime.Text;
  Fantasia := EdtFantasia.Text;
  telefone := EdtTelefone.Text;

  if EdtRazaoSocial.Text = '' then begin
  ShowMessage('Nome não pode ficar em branco!');
  end
  else begin

  if EdtFantasia.Text = '' then begin
  ShowMessage('Fantasia não pode ficar em branco!');
  end
  else begin

  if EdtCNPJ.Text = '' then begin
  ShowMessage('CNPJ não pode ficar em branco!');
  end
  else begin

  if EdtIE.Text = '' then begin
  ShowMessage('IE não pode ficar em branco!');
  end
  else begin

  if EdtRua.Text = '' then begin
  ShowMessage('Rua não pode ficar em branco!');
  end
  else begin

  if EdtNumero.Text = '' then begin
  ShowMessage('Numero não pode ficar em branco!');
  end
  else begin

  if EdtEstado.Text = '' then begin
  ShowMessage('Estado não pode ficar em branco!');
  end
  else begin

  if EdtBairro.Text = '' then begin
  ShowMessage('Bairro não pode ficar em branco!');
  end
  else begin

  if EdtCidade.Text = '' then begin
  ShowMessage('Cidade não pode ficar em branco!');
  end
  else begin

  if EdtPais.Text = '' then begin
  ShowMessage('País não pode ficar em branco!');
  end
  else begin

  if Edtcomplemento.Text = '' then begin
  ShowMessage('Complemento não pode ficar em branco!');
  end
  else begin

  if EdtSerie.Text = '' then begin
  ShowMessage('Série não pode ficar em branco!');
  end
  else begin

  if EdtTelefone.Text = '' then begin
  ShowMessage('Telefone não pode ficar em branco!');
  end
  else begin

  if CBRegime.Text = '' then begin
  Showmessage('Regime não selecionad!');
  end
  else begin

  CadEmpresaDataModule.InsertQuery.SQL.Clear;
  CadEmpresaDataModule.InsertQuery.SQL.Text :=
  'update empresa set telefone = :telefone, nome = :nome, cnpj = :cnpj, IE = :IE, Rua = :rua, numero = :numero, estado = :estado, bairro = :bairro, cidade = :cidade, ' +
  'pais = :pais, complemento = :complemento, cep = :cep, CRT = :CRT, fantasia = :fantasia, serie = :serie where EMP_ID = :EMP_ID';
  CadEmpresaDataModule.InsertQuery.ParamByName('nome').AsString := nome;
  CadEmpresaDataModule.InsertQuery.ParamByName('cnpj').AsString := cnpj;
  CadEmpresaDataModule.InsertQuery.ParamByName('IE').AsString := IE;
  CadEmpresaDataModule.InsertQuery.ParamByName('rua').AsString := rua;
  CadEmpresaDataModule.InsertQuery.ParamByName('numero').AsString := numero;
  CadEmpresaDataModule.InsertQuery.ParamByName('estado').AsString := estado;
  CadEmpresaDataModule.InsertQuery.ParamByName('bairro').AsString := bairro;
  CadEmpresaDataModule.InsertQuery.ParamByName('cidade').AsString := cidade;
  CadEmpresaDataModule.InsertQuery.ParamByName('pais').AsString := pais;
  CadEmpresaDataModule.InsertQuery.ParamByName('complemento').AsString := complemento;
  CadEmpresaDataModule.InsertQuery.ParamByName('cep').AsString := cep;
  CadEmpresaDataModule.InsertQuery.ParamByName('serie').AsString := serie;
  CadEmpresaDataModule.InsertQuery.ParamByName('EMP_ID').AsString := EMP_ID;
  CadEmpresaDataModule.InsertQuery.ParamByName('CRT').AsString := CRT;
  CadEmpresaDataModule.InsertQuery.ParamByName('Fantasia').AsString := Fantasia;
  CadEmpresaDataModule.InsertQuery.ParamByName('Telefone').AsString := Telefone;

  LogModule.InserirLog.SQL.Clear;
  LogModule.InserirLog.SQL.Text :=
  'insert into logs (descricao, data, tela, usuario, emp_id)' +
  'values ' +
  '(:descricao, :data, :tela, :usuario, :emp_id)';
  LogModule.InserirLog.ParamByName('descricao').AsString :=
  'Alterou a empresa ' + nome + ' no CNPJ ' + CNPJ + ' na IE ' + IE + ' no CEP ' + CEP + ' na série ' + serie + ' no Regime ' + CRT;
  LogModule.InserirLog.ParamByName('data').AsDateTime := data;
  LogModule.InserirLog.ParamByName('tela').AsString := tela;
  LogModule.InserirLog.ParamByName('usuario').AsString := UsuarioLogado;
  LogModule.InserirLog.ParamByName('emp_id').AsString := EmpresaLogada;
  try
  LogModule.InserirLog.ExecSQL;
  CadEmpresaDataModule.InsertQuery.ExecSQL;
  showmessage('Gravado com sucesso');
  EdtRazaoSocial.Enabled := False;
  EdtCNPJ.Enabled := False;
  EdtIE.Enabled := False;
  EdtRua.Enabled := False;
  EdtNumero.Enabled := False;
  EdtBairro.Enabled := False;
  EdtComplemento.Enabled := False;
  EdtCEP.Enabled := False;
  edtserie.Enabled := False;
  EdtEMP_ID.Enabled := False;
  CBRegime.Enabled := False;
  EdtFantasia.Enabled := False;
  EdtTelefone.Enabled := False;

  btnIncluir.Visible := True;
  btnAlterar.Visible := True;

  SBCEP.Enabled := False;
  btnGravarIncluir.Visible := False;
  btnDesistir.Visible := False;
  except
  showmessage('Erro na gravação');
  end;
end;
end;
end;
end;
end;
end;
end;
end;
end;
end;
end;
end;
end;
end;
end;

procedure TCadEmpresa.BtnDesistirClick(Sender: TObject);
begin
 EdtRazaoSocial.Clear;
 EdtCNPJ.Clear;
 EdtIE.Clear;
 EdtRua.Clear;
 EdtNumero.Clear;
 EdtEstado.Clear;
 EdtBairro.Clear;
 EdtCidade.Clear;
 EdtPais.Clear;
 EdtComplemento.Clear;
 EdtCEP.Clear;
 EdtEMP_ID.Clear;
 edtserie.Clear;
 EdtFantasia.Clear;
 EdtTelefone.Clear;

 EdtRazaoSocial.Enabled := False;
 EdtCNPJ.Enabled := False;
 EdtIE.Enabled := False;
 EdtRua.Enabled := False;
 EdtNumero.Enabled := False;
 EdtBairro.Enabled := False;
 EdtComplemento.Enabled := False;
 EdtCEP.Enabled := False;
 edtserie.Enabled := False;
 EdtEMP_ID.Enabled := False;
 CBRegime.Enabled := False;
 EdtFantasia.Enabled := False;
 EdtTelefone.Enabled := False;

 btnIncluir.Visible := True;
 btnAlterar.Visible := True;

 SBCEP.Enabled := False;
 btnGravarIncluir.Visible := False;
 btnDesistir.Visible := False;
end;

procedure TCadEmpresa.SBCEPClick(Sender: TObject);
var CEP, Cidade, Estado, Pais: string;
begin
 CadCEPDataModule.ConsultarCEP.SQL.Clear;
 CadCEPDataModule.ConsultarCEP.SQL.Text :=
 'select * from cadcep where ativo = :ativo';
 CadCEPDataModule.ConsultarCEP.ParamByName('ativo').AsString := 'S';
 CadCEPDataModule.ConsultarCEP.Open;

 Application.CreateForm(TConsultarCEP, ConsultarCEP);
 CEP := ConsultarCEP.SelecionarCEP;
 Cidade := ConsultarCEP.Cidade;
 Estado := ConsultarCEP.Estado;
 Pais := ConsultarCEP.Pais;
 if cep <> '' then
 begin
 EdtCEP.Text := CEP;
 EdtCidade.Text := Cidade;
 EdtEstado.Text := Estado;
 EdtPais.Text := Pais;
 end;
end;

procedure TCadEmpresa.btnFecharClick(Sender: TObject);
begin
 (Parent as TTabSheet).PageControl := nil;
 Parent.Free;
end;
end.
