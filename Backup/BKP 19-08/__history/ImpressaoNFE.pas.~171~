unit ImpressaoNFE;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.ExtCtrls, Vcl.ComCtrls, Vcl.StdCtrls,
  Data.DB, Vcl.Grids, Vcl.DBGrids, Vcl.Buttons, XML.XMLDoc, XMLIntf,
  GlobalUnit,
  ImpressaoNFEDataModule, ConsultarFaturaForm,
  EntidadeDataModule, ConsultarEntidadeForm,
  NaturezaDataModule, ConsultarNaturezaForm;

type
  TImpressaoNFEForm = class(TForm)
    Panel1: TPanel;
    lblDTInicio: TLabel;
    lbldtFim: TLabel;
    EdtInicio: TDateTimePicker;
    EdtFim: TDateTimePicker;
    lblFatura: TLabel;
    EdtFatura: TEdit;
    lblEMP_ID: TLabel;
    EdtEMP_ID: TEdit;
    lblSerie: TLabel;
    EdtSerie: TEdit;
    lblEntidade: TLabel;
    EdtEntidade: TEdit;
    lblNatureza: TLabel;
    EdtNatureza: TEdit;
    GridNotas: TDBGrid;
    btnTransmitir: TButton;
    btnConsultar: TButton;
    btnCancelar: TButton;
    btnConsultarFiltros: TButton;
    GridINotaIten: TDBGrid;
    SBEntidade: TSpeedButton;
    SBFatura: TSpeedButton;
    SBNatureza: TSpeedButton;
    RBTodas: TRadioButton;
    RGImpressa: TRadioGroup;
    RBImpresso: TRadioButton;
    RBNaoImpressas: TRadioButton;
    RBCanceladas: TRadioButton;
    btnFechar: TButton;
    lblChave_NFE: TLabel;
    EdtChave_NFE: TEdit;
    lblRecibo_NFE: TLabel;
    EdtRecibo_NFE: TEdit;
    lblProtocolo_NFE: TLabel;
    EdtProtocolo_NFE: TEdit;
    lblEmissao_NFE: TLabel;
    DTPEmissao_NFE: TDateTimePicker;
    lblModo: TLabel;
    CBModo: TComboBox;
    lblAmbiente: TLabel;
    CBAmbiente: TComboBox;
    lblFinalidade: TLabel;
    CBFinalidade: TComboBox;
    procedure btnConsultarFiltrosClick(Sender: TObject);
    procedure SBEntidadeClick(Sender: TObject);
    procedure SBNaturezaClick(Sender: TObject);
    procedure SBFaturaClick(Sender: TObject);
    procedure GridNotasCellClick(Column: TColumn);
    procedure btnFecharClick(Sender: TObject);
    procedure btnTransmitirClick(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
  end;

var
  ImpressaoNFEForm: TImpressaoNFEForm;

implementation

{$R *.dfm}

function FormataValorNFe(Value: Double): string;
begin
  Result := FormatFloat('0.00', Value).Replace(',', '.');
end;

procedure TImpressaoNFEForm.btnConsultarFiltrosClick(Sender: TObject);
var dtinicio, dtfim: tDate;
    emp_id, fatura, faturaselecionada, serie, natureza, entidade, impresso: String;
begin
 dtinicio:= Edtinicio.date;
 dtfim:= Edtfim.date;
 fatura:= EdtFatura.Text;
 EMP_ID:= EdtEmp_ID.Text;
 serie:= EdtSerie.Text;
 natureza:= Edtnatureza.Text;
 entidade:= EdtEntidade.Text;
 if RBImpresso.Checked then
 impresso:= 'S'
 else if RBNaoImpressas.Checked then
 impresso:= 'N'
 else if RBCanceladas.Checked then
 impresso:= 'C';

 ImpressaoNFEFormDataModule.SelectNotaQuery.SQL.Clear;
 ImpressaoNFEFormDataModule.SelectNotaQuery.Close;
 ImpressaoNFEFormDataModule.SelectNotaQuery.SQL.Text:=
 'select n.* from nota n ' +
 'inner join notaiten ni on (ni.fatura = n.fatura) and (n.id = ni.id_nota) ' +
 'where cast(n.dtemissao as date) between :datainicio and :datafim ';
 ImpressaoNFEFormDataModule.SelectNotaQuery.Parambyname('datainicio').AsDate:= dtInicio;
 ImpressaoNFEFormDataModule.SelectNotaQuery.Parambyname('datafim').AsDate:= dtfim;

 if EdtFatura.Text <> '' then begin
 ImpressaoNFEFormDataModule.SelectNotaQuery.SQL.Add(' and n.fatura = :fatura');
 ImpressaoNFEFormDataModule.SelectNotaQuery.ParamByName('fatura').AsString:= fatura;
 end;

 if EdtEMP_ID.Text <> '' then begin
 ImpressaoNFEFormDataModule.SelectNotaQuery.SQL.ADD(' and n.emp_id = :emp_id');
 ImpressaoNFEFormDataModule.SelectNotaQuery.ParamByName('emp_id').AsString:= emp_id;
 end
 else begin
 ImpressaoNFEFormDataModule.SelectNotaQuery.SQL.ADD(' and n.emp_id = :empresalogada');
 ImpressaoNFEFormDataModule.SelectNotaQuery.ParamByName('empresalogada').AsString := Empresalogada;
 end;

 if EdtSerie.Text <> '' then begin
 ImpressaoNFEFormDataModule.SelectNotaQuery.SQL.Add(' and n.serie = :serie');
 ImpressaoNFEFormDataModule.SelectNotaQuery.ParamByName('serie').AsString:= serie;
 end;

 if Edtnatureza.Text <> '' then begin
 ImpressaoNFEFormDataModule.SelectNotaQuery.SQL.Add(' and n.natureza = :natureza');
 ImpressaoNFEFormDataModule.SelectNotaQuery.ParamByName('natureza').AsString:= natureza;
 end;

 if EdtEntidade.Text <> '' then begin
 ImpressaoNFEFormDataModule.SelectNotaQuery.SQL.Add(' and n.codcli = :entidade');
 ImpressaoNFEFormDataModule.SelectNotaQuery.ParamByName('entidade').AsString:= entidade;
 end;

 if Impresso <> '' then begin
 ImpressaoNFEFormDataModule.SelectNotaQuery.SQL.Add(' and n.impresso = :impresso');
 ImpressaoNFEFormDataModule.SelectNotaQuery.ParamByName('impresso').AsString := Impresso;
 end;
 ImpressaoNFEFormDataModule.SelectNotaQuery.Open;
end;

procedure TImpressaoNFEForm.btnFecharClick(Sender: TObject);
begin
 Fechartela(sender);
end;

procedure TImpressaoNFEForm.btnTransmitirClick(Sender: TObject);
var
  XMLDoc: IXMLDocument;
  nfeProcNode, NFeNode, infNFeNode, ideNode, emitnode, enderEmitNode, destnode, enderdestnode, detnode, prodnode, gCrednode, impostonode, ICMSNode, ICMS40Node,
  IPINode, IPINTNode, PISNode, PISAliqNode, COFINSNode, COFINSAliqNode, TotalNode, ICMSTotNode, transpnode, volnode, infadicnode, infRespTecnode,
  SignatureNode, SignedInfoNode, ReferenceNode, TransformsNode, KeyInfoNode, X509DataNode, protNFeNode, infProtNode, CanonicalizationMethodNode, SignatureMethodNode,
  TransformNode1, TransformNode2: IXMLNode;
  nitem: integer;
  Aliq_Cred_Pres, vNF: double;
begin
    ImpressaoNFEFormDataModule.TransmitirNotaQuery.SQL.Clear;
    ImpressaoNFEFormDataModule.TransmitirNotaQuery.SQL.Text :=
      'SELECT N.ID, N.Fatura, N.EMP_ID, N.Serie, N.Codcli, N.dtEmissao, N.dtSaida, ' +
      'N.Natureza as natureza_nota, N.valor_produtos, N.valor_total, N.valor_icms, N.valor_base_icms, ' +
      'N.valor_frete, N.valor_ipi, N.valor_base_ipi, ' +
      'N.valor_cofins, N.valor_base_cofins, N.valor_pis, N.valor_base_pis, ' +
      'N.valor_desconto, N.quantidade, N.aliq_icms, N.aliq_ipi, N.aliq_pis, ' +
      'N.aliq_cofins, N.Impresso, n.dados_adicionais, n.especie, n.volumes, n.pesob, n.pesol, n.presenca, n.modfrete, ' +
      'ni.ID_NOTA, ni.fatura, ni.EMP_ID, ni.Serie, ni.Codigo as codigo_produto, ni.Tam, ni.Cor, ' +
      'ni.Deposito, ni.Lote, ni.CST_ICMS, ni.CSOSN, ni.val_icms, ni.val_base_icms, ' +
      'ni.aliq_icms, ni.CST_IPI, ni.ENQ_IPI, ni.aliq_ipi, ni.val_ipi, ni.val_base_ipi, ' +
      'ni.CST_COFINS, ni.aliq_cofins, ni.val_cofins, ni.val_base_cofins, ni.natureza as natureza_itens, ' +
      'ni.val_desconto, ni.preco_uni, ni.qtde as qtde_itens, ni.valor as valor_item, ni.CST_PIS, ni.ALIQ_PIS, ' +
      'ni.val_pis, ni.val_base_pis, ni.cBenef, ni.cCredPres, ni.val_frete, ' +
      'nat.descricao, nat.tipo, nat.natureza, nat.Aliq_Cred_Pres, ' +
      'cid.codigo as cod_cidade, ' +
      'ent.consumidor_final as ENT_Consumidor_final, ent.CPF as ent_CPF, ent.Nome as ENT_NOME, ent.rua as ent_rua, ent.numero as ent_numero, ent.complemento as ent_complemento, ' +
      'ent.Bairro as ent_bairro, ent.Estado as ent_Estado, ent.CEP as Ent_CEP, ent.telefone as ent_telefone, ent.cidade as ent_cidade, ent.IE as ENT_IE, ent.IndIE, ' +
      'emp.CNPJ as emp_cnpj, emp.Nome as emp_nome, ' +
      'emp.Rua as Emp_Rua, emp.numero as Emp_numero, emp.bairro as emp_bairro, emp.cidade as emp_cidade, emp.estado as emp_estado, emp.CEP as emp_cep, emp.IE as emp_ie, ' +
      'emp.CRT as emp_CRT, emp.Fantasia as EMP_FANTASIA, emp.telefone as emp_telefone, ' +
      'pais.codigo as codigo_pais, pais.pais as nome_pais, ' +
      'prod.ncm as NCM_produto, prod.descricao as Descricao_produto, prod.UniVenda as PROD_UNIVENDA, prod.origem as PROD_ORIGEM, prod.brinde as PROD_BRINDE, ' +
      'estado.codigo as codigo_estado ' +
      'FROM nota n ' +
      'INNER JOIN notaiten ni ON (ni.id_nota=n.id) AND (ni.fatura=n.fatura) ' +
      'AND (ni.serie=n.serie) AND (ni.emp_id=n.emp_id) ' +
      'inner join cadnatureza nat on (nat.natureza = n.natureza) ' +
      'inner join empresa emp on (n.emp_id = emp.emp_id) ' +
      'inner join cadcep cep on (emp.cep = cep.cep) ' +
      'inner join cadcidade cid on (cep.cidade = cid.cidade) ' +
      'inner join cadentidade ent on (ent.nome = n.codcli) ' +
      'inner join cadpais pais on (pais.sigla = emp.pais) ' +
      'inner join cadproduto prod on (prod.codigo = ni.codigo) ' +
      'inner join cadestado estado on (estado.sigla = cep.estado) ' +
      'WHERE N.FATURA = :FATURA';
    ImpressaoNFEFormDataModule.TransmitirNotaQuery.ParamByName('fatura').AsString := GridNotas.DataSource.DataSet.FieldByName('fatura').AsString;
    ImpressaoNFEFormDataModule.TransmitirNotaQuery.Open;

    Aliq_Cred_pres := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('Aliq_Cred_Pres').AsFloat;
    vNF := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('valor_total').AsFloat;

  try
    XMLDoc := NewXMLDocument;
    XMLDoc.Encoding := 'UTF-8';
    XMLDoc.Options := [doNodeAutoIndent];

    nfeProcNode := XMLDoc.AddChild('nfeProc', 'http://www.portalfiscal.inf.br/nfe');
    nfeProcNode.Attributes['versao'] := '4.00';

    NFeNode := NfeProcNode.AddChild('NFe');
    NFeNode.Attributes['xmlns'] := 'http://www.portalfiscal.inf.br/nfe';

    infNFeNode := NFeNode.AddChild('infNFe');
    InfNFeNode.Attributes['Id'] := 'NFe' + ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('Fatura').AsString;
    InfNFeNode.Attributes['versao'] := '4.00';

    ideNode := infNFeNode.AddChild('ide');
    idenode.AddChild('cUF').Text := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('codigo_estado').AsString;
    idenode.AddChild('cNF').Text := 'numeroaleatorio';
    idenode.AddChild('natOp').Text := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('descricao').AsString;
    idenode.AddChild('mod').Text := '55';
    idenode.AddChild('serie').Text := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('serie').AsString;
    idenode.AddChild('nNF').Text := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('fatura').AsString;
    idenode.AddChild('dhEmi').Text := FormatDateTime('yyyy"-"mm"-"dd"T"hh":"nn":"ss"-03:00"', ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('dtemissao').AsDateTime);
    idenode.AddChild('dhSaiEnt').Text := FormatDateTime('yyyy"-"mm"-"dd"T"hh":"nn":"ss"-03:00"', ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('dtsaida').AsDateTime);
    if ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('tipo').AsString = 'S' then
    idenode.AddChild('tpNF').Text := '1' else idenode.AddChild('tpNF').Text := '0';
    case ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('natureza').AsString [1] of
    '1', '5': idenode.AddChild('idDest').Text := '1';
    '2', '6': idenode.AddChild('idDest').Text := '2';
    '3', '7': idenode.AddChild('idDest').Text := '3';
    end;
    idenode.AddChild('cMunFG').Text := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('cod_cidade').AsString;
    idenode.AddChild('tpImp').Text := '0';
    if CBModo.Text = 'Emissão normal' then
    idenode.AddChild('tpEmis').Text := '1'
    else if CBModo.Text = 'Contingência FS-IA' then
    idenode.AddChild('tpEmis').Text := '2'
    else if CBModo.Text = 'Contingência SCAN' then
    idenode.AddChild('tpEmis').Text := '3'
    else if CBModo.Text = 'Contingência DPEC' then
    idenode.AddChild('tpEmis').Text := '4'
    else if CBModo.Text = 'Contingência FS-DA' then
    idenode.AddChild('tpEmis').Text := '5'
    else if CBModo.Text = 'Contingência SVC-AN' then
    idenode.AddChild('tpEmis').Text := '6'
    else if CBModo.Text = 'Contingência SVC-RS' then
    idenode.AddChild('tpEmis').Text := '7';

    idenode.AddChild('cDV').Text := 'teste';

    if CBAmbiente.Text = 'Homologação' then
    idenode.AddChild('tpAmb').Text := '2'
    else if CBAmbiente.Text = 'Produção' then
    idenode.AddChild('tpAmb').Text := '1';
    if CBFinalidade.Text = 'Normal' then
    idenode.AddChild('finNFe').Text := '1'
    else if CBFinalidade.Text = 'Ajuste' then
    idenode.AddChild('finNFe').Text := '3'
    else if CBFinalidade.Text = 'Complementar' then
    idenode.AddChild('finNFe').Text := '2'
    else if CBFinalidade.Text = 'Devolução' then
    idenode.AddChild('finNFe').Text := '4';
    case ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('ENT_consumidor_final').AsString [1] of
    'S': idenode.AddChild('indFinal').Text := '1';
    'N': idenode.AddChild('indFinal').Text := '0';
    end;
    idenode.AddChild('indPres').Text := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('presenca').AsString;
    idenode.AddChild('indIntermed').Text := '0';
    idenode.AddChild('procEmi').Text := '0';
    idenode.AddChild('verProc').Text := 'SisFey v1';

    emitnode := infNFeNode.AddChild('emit');
    emitnode.AddChild('CNPJ').Text := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('Emp_CNPJ').AsString;
    emitnode.AddChild('xNome').Text := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('Emp_Nome').AsString;
    emitnode.AddChild('xFant').Text := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('Emp_Fantasia').AsString;

    enderEmitNode := EmitNode.AddChild('enderEmit');
    EnderEmitNode.AddChild('xLgr').Text := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('Emp_Rua').AsString;
    EnderEmitNode.AddChild('nro').Text := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('Emp_Numero').AsString;
    EnderEmitNode.AddChild('xBairro').Text := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('Emp_Bairro').AsString;
    EnderEmitNode.AddChild('cMun').Text := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('cod_cidade').AsString;
    EnderEmitNode.AddChild('xMun').Text := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('emp_cidade').AsString;
    EnderEmitNode.AddChild('UF').Text := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('emp_estado').AsString;
    EnderEmitNode.AddChild('CEP').Text := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('emp_CEP').AsString;
    EnderEmitNode.AddChild('cPais').Text := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('codigo_pais').AsString;
    EnderEmitNode.AddChild('xPais').Text := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('nome_pais').AsString;
    EnderEmitNode.AddChild('fone').Text := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('emp_telefone').AsString;

    EmitNode.AddChild('IE').Text := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('EMP_IE').AsString;
    EmitNode.AddChild('CRT').Text := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('EMP_CRT').AsString;

    destnode := infnfenode.AddChild('dest');
    destnode.AddChild('CNPJ').Text := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('ENT_CPF').AsString;
    destnode.AddChild('xNome').Text := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('ENT_Nome').AsString;

    enderdestnode := destnode.AddChild('enderDest');
    enderdestnode.AddChild('xLgr').Text := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('ENT_Rua').AsString;
    enderdestnode.AddChild('nro').Text := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('ENT_Numero').AsString;
    enderdestnode.AddChild('xBairro').Text := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('ENT_Bairro').AsString;
    enderdestnode.AddChild('cMun').Text := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('cod_cidade').AsString;
    enderdestnode.AddChild('xMun').Text := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('ENT_cidade').AsString;
    enderdestnode.AddChild('UF').Text := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('ENT_estado').AsString;
    enderdestnode.AddChild('CEP').Text := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('ENT_CEP').AsString;
    enderdestnode.AddChild('cPais').Text := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('codigo_pais').AsString;
    enderdestnode.AddChild('xPais').Text := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('nome_pais').AsString;
    enderdestnode.AddChild('fone').Text := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('ent_telefone').AsString;

    destnode.AddChild('indIEDest').Text := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('IndIE').AsString;
    destnode.AddChild('IE').Text := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('ENT_IE').AsString;

    detnode := infnfenode.AddChild('det');
    nItem := detnode.ChildNodes.Count + 1;
    detnode.Attributes['nItem'] := IntToStr(nItem);

    prodnode := detnode.AddChild('prod');
    prodnode.AddChild('cProd').Text := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('Codigo_produto').AsString;
    prodnode.AddChild('cEAN').Text := 'SEM GTIN';
    prodnode.AddChild('xProd').Text := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('Descricao_produto').AsString;
    prodnode.AddChild('NCM').Text := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('NCM_produto').AsString;

    if ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('cBenef').AsString <> '' then
    prodnode.AddChild('cBenef').Text := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('cBenef').AsString;

    if ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('cCredPres').AsString <> '' then
    gCredNode := prodnode.AddChild('gCred');
    gCredNode.AddChild('cCredPresumido').Text := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('cCredPres').AsString;
    gCredNode.AddChild('pCredPresumido').Text := FormataValorNFe((Aliq_Cred_Pres));
    gCredNode.AddChild('vCredPresumido').Text := FormataValorNFe((((Aliq_Cred_Pres) * vNF)/100));

    prodnode.AddChild('CFOP').Text := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('Natureza_itens').AsString;
    prodnode.AddChild('uCom').Text := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('PROD_UNIVENDA').AsString;
    prodnode.AddChild('qCom').Text := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('qtde_itens').AsString;
    prodnode.AddChild('vUnCom').Text := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('preco_uni').AsString;
    prodnode.AddChild('vProd').Text := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('valor_item').AsString;
    prodnode.AddChild('cEANTrib').Text := 'SEM GTIN';
    prodnode.AddChild('uTrib').Text := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('PROD_UNIVENDA').AsString;
    prodnode.AddChild('qTrib').Text := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('qtde_itens').AsString;
    prodnode.AddChild('vUnTrib').Text := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('preco_uni').AsString;
    if ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('prod_brinde').AsString = 'S' then prodnode.AddChild('indTot').Text := '0'
    else prodnode.AddChild('indTot').Text := '1';


    impostonode := detnode.AddChild('imposto');
    ICMSNode := impostonode.AddChild('ICMS');
    ICMS40Node := ICMSNode.AddChild('ICMS40');

    ICMS40Node.AddChild('orig').Text := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('PROD_ORIGEM').AsString;
    ICMS40Node.AddChild('CST').Text := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('CST_ICMS').AsString;

    IPINode := Impostonode.AddChild('IPI');
    IPINode.AddChild('cEnq').Text := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('ENQ_IPI').AsString;

    IPINTNode := IPINode.AddChild('IPINT');
    IPINTNode.AddChild('CST').Text := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('CST_IPI').AsString;

    PISNode := impostonode.AddChild('PIS');
    PISAliqNode := PISNode.AddChild('PISAliq');
    PisALiqNode.AddChild('CST').Text := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('CST_PIS').AsString;
    PisALiqNode.AddChild('vBC').Text := FormatFloat('0.00', ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('val_base_pis').AsFloat);
    PisALiqNode.AddChild('pPIS').Text := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('Aliq_PIS').AsString;
    PisALiqNode.AddChild('vPIS').Text := FormatFloat('0.00', ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('val_pis').AsFloat);

    COFINSNode := impostonode.AddChild('COFINS');
    COFINSAliqNode := COFINSNode.AddChild('COFINSAliq');
    COFINSALiqNode.AddChild('CST').Text := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('CST_COFINS').AsString;
    COFINSALiqNode.AddChild('vBC').Text := FormatFloat('0.00', ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('val_base_COFINS').AsFloat);
    COFINSALiqNode.AddChild('pCOFINS').Text := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('Aliq_COFINS').AsString;
    COFINSALiqNode.AddChild('vCOFINS').Text := FormatFloat('0.00', ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('val_COFINS').AsFloat);

    TotalNode := InfNFENode.AddChild('total');
    ICMSTotNode := TotalNode.AddChild('ICMSTot');
    ICMSTotNode.AddChild('vBC').Text := FormatFloat('0.00', ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('valor_base_icms').AsFloat);
    ICMSTotNode.AddChild('vICMS').Text := FormatFloat('0.00', ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('valor_icms').AsFloat);
    ICMSTotNode.AddChild('vICMSDeson').Text := 'fazer';
    ICMSTotNode.AddChild('vFCP').Text := 'fazer';
    ICMSTotNode.AddChild('vBCST').Text :=  'fazer';
    ICMSTotNode.AddChild('vST').Text := 'fazer';
    ICMSTotNode.AddChild('vFCPST').Text :=  'fazer';
    ICMSTotNode.AddChild('vFCPSTRet').Text :=  'fazer';
    ICMSTotNode.AddChild('vProd').Text := FormatFloat('0.00', ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('valor_produtos').AsFloat);
    ICMSTotNode.AddChild('vFrete').Text := FormatFloat('0.00', ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('valor_frete').AsFloat);
    ICMSTotNode.AddChild('vSeg').Text := 'fazer';
    ICMSTotNode.AddChild('vDesc').Text := FormatFloat('0.00', ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('valor_desconto').AsFloat);
    ICMSTotNode.AddChild('vII').Text :=  'fazer';
    ICMSTotNode.AddChild('vIPI').Text := FormatFloat('0.00', ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('valor_ipi').AsFloat);
    ICMSTotNode.AddChild('vIPIDevol').Text :=  'fazer';
    ICMSTotNode.AddChild('vPIS').Text := FormatFloat('0.00', ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('valor_pis').AsFloat);
    ICMSTotNode.AddChild('vCOFINS').Text := FormatFloat('0.00', ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('valor_cofins').AsFloat);
    ICMSTotNode.AddChild('vOutro').Text := 'fazer';
    ICMSTotNode.AddChild('vNF').Text := FormatFloat('0.00', ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('valor_total').AsFloat);

    transpnode := infnfenode.AddChild('transp');
    transpnode.AddChild('modFrete').Text := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('modfrete').AsString;

    volnode := transpnode.AddChild('vol');
    volnode.AddChild('qVol').Text := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('volumes').AsString;
    volnode.AddChild('esp').Text := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('especie').AsString;
    volnode.AddChild('pesoL').Text := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('pesol').AsString;
    volnode.AddChild('pesoB').Text := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('pesob').AsString;

    infAdicnode := infnfenode.AddChild('infAdic');

    infadicnode.AddChild('infCpl').Text := ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('dados_adicionais').AsString;

    infRespTecnode := infNFeNode.AddChild('infRespTec');

    infRespTecnode.AddChild('CNPJ').Text := '00012034977920';
    infRespTecnode.AddChild('xContato').Text := 'Enzo Vinicius Fey';
    infRespTecNode.AddChild('email').Text := 'enzofey047@gmail.com';
    infRespTecNode.AddChild('fone').Text := '047992906510';

    SignatureNode := NFeNode.AddChild('Signature');
    SignatureNode.Attributes['xmlns'] := 'http://www.w3.org/2000/09/xmldsig#';

    SignedInfoNode := SignatureNode.AddChild('SignedInfo');

    CanonicalizationMethodNode := SignedInfoNode.AddChild('CanonicalizationMethod');
    CanonicalizationMethodNode.Attributes['Algorithm'] := 'http://www.w3.org/TR/2001/REC-xml-c14n-20010315';

    SignatureMethodNode := SignedInfoNode.AddChild('SignatureMethod');
    SignatureMethodNode.Attributes['Algorithm']:= 'http://www.w3.org/2000/09/xmldsig#rsa-sha1';

    ReferenceNode := SignedInfoNode.AddChild('Reference');
    ReferenceNode.Attributes['URI'] := '#NFe42250711726756000139550010001388111301355478';

    TransformsNode := ReferenceNode.AddChild('Transforms');

    TransformNode1 := TransformsNode.AddChild('Transform');
    TransformNode1.Attributes['Algorithm'] := 'http://www.w3.org/2000/09/xmldsig#enveloped-signature';

    TransformNode2 := TransformsNode.AddChild('Transform');
    TransformNode2.Attributes['Algorithm'] := 'http://www.w3.org/TR/2001/REC-xml-c14n-20010315'

    ReferenceNode.AddChild('DigestMethod', 'Algorithm=http://www.w3.org/2000/09/xmldsig#sha1');
    ReferenceNode.AddChild('DigestValue', 'CHPmn9OQGWW7Xzh8uDw9M94uY5U=');

    SignatureNode.AddChild('SignatureValue').Text := 'Dx/kbiF1Kn5eMu+UwE0tQIQlMswfx6xWm2Hcl0kNzg2SzxiyrVH0K3bbYQnLIEntr1NWh/ubcWI0cKEWNSpSqlP0jrbTdxy05D19Dl2WA/U636vESfqpIVLKFG8A49imtNOJTXjfwRmFubDoFemv1zyKBE5kXHdaIaPk4UmcDm+ybRcKd+9g0/cgZk/akDZMHev+QJg8XeTB+GvcCZ6CTr6TzTxinHzYj2HM0fVyayc92JsMs+cm5be9NYe2sgXtdA6vj9R6L1txJVjbdQj9+pXDVl7HBOmssHCFqZ1FIf54vbGRjkbvV4LvAI1IN9Bz9kyAJdMZ7DVpldwShJlfMw==';

    KeyInfoNode := SignatureNode.AddChild('KeyInfo');

    X509DataNode := KeyInfoNode.AddChild('X509Data');
    X509DataNode.AddChild('X509Certificate').text :=
    'MIIHuDCCBaCgAwIBAgIIdk2YdqxCvjMwDQYJKoZIhvcNAQELBQAwdzELMAkGA1UEBhMCQlIxEzARBgNVBAoTCklDUC1CcmFzaWwxNjA0BgNVBAsTLVNlY3JldGFyaWEgZGEgUmVjZWl0YSBGZWRlcmFsIGRvIEJyYXNpbCAtIFJGQjEbMBkGA1UEAxMSQUMgRE9DQ0xPVUQgUkZCIHYyMB4XDTI0MTExMTEzMzUwN1oXDTI1MTExMTEzMzUwN1owggEMMQswCQYDVQQGEwJCUjETMBEGA1UEChMKSUNQLUJyYXNpbDELMAkGA1UECBMCU0MxDzANBgNVBAcTBkdBU1BBUjE2MDQGA1UECxMtU2VjcmV0YXJpYSBkYSBSZWNlaXRhIEZlZGVyYWwgZG8gQnJhc2lsIC0gUkZCMRYwFAYDVQQLE' +
    'w1SRkIgZS1DTlBKIEExMRcwFQYDVQQLEw4xOTkwNzc4NzAwMDEwNjEZMBcGA1UECxMQdmlkZW9jb25mZXJlbmNpYTFGMEQGA1UEAxM9RERYIFRFWFRJTCBJTkRVU1RSSUEgRSBDT01FUkNJTyBERSBNQUxIQVMgTFREQToxMTcyNjc1NjAwMDEzOTCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAPnr4+TQV/GVKKlw1KaC0BodFYgBZY7rsr4I4a/do8u3V42o+9do2jROHdSq3Lko8205bErQE8cmInM5It2ci0qs0is1L5fERlTitCXDb7q3lcoNtEyDoiLPTIY0F5FUPslfVKds+k6ALozsGFwmFnQJtcRKmMK5XHON7N3QaveztwJ8poAu1U17kYf29J2DMNrvhb8pAhwkLKXDEjar' +
    'v0n5WegzVgMlQhzBX55AYi/c+/5Bo+1QQ0B/2GR08ISUl7ZoSiqHn1mq19WNZTt7UMiEhXYfQhIFzWiKta4Uz4sfdGRj4To/jHvkKHSHuxn+NERJwHTUsnCPRtKHAfkIr9kCAwEAAaOCAq8wggKrMB8GA1UdIwQYMBaAFJ7MTbgwg/Rmw2KqNo/HDB8QaSWcMA4GA1UdDwEB/wQEAwIF4DBsBgNVHSAEZTBjMGEGBmBMAQIBOjBXMFUGCCsGAQUFBwIBFklodHRwOi8vcmVwb3NpdG9yaW8uYWNkb2NjbG91ZC5jb20uYnIvYWMtZG9jY2xvdWRyZmIvZHBjLWFjZG9jY2xvdWRyZmIucGRmMIG0BgNVHR8EgawwgakwUqBQoE6GTGh0dHA6Ly9yZXBvc2l0b3Jpby5hY2RvY2Nsb3VkLmNvbS5ici9h' +
    'Yy1kb2NjbG91ZHJmYi9sY3ItYWMtZG9jY2xvdWRyZmJ2NS5jcmwwU6BRoE+GTWh0dHA6Ly9yZXBvc2l0b3JpbzIuYWNkb2NjbG91ZC5jb20uYnIvYWMtZG9jY2xvdWRyZmIvbGNyLWFjLWRvY2Nsb3VkcmZidjUuY3JsMGQGCCsGAQUFBwEBBFgwVjBUBggrBgEFBQcwAoZIaHR0cDovL3JlcG9zaXRvcmlvLmFjZG9jY2xvdWQuY29tLmJyL2FjLWRvY2Nsb3VkcmZiL2FjLWRvY2Nsb3VkcmZidjUucDdiMIHCBgNVHREEgbowgbeBHUxVQ0FTLlBPTEVaQUBERFhURVhUSUwuQ09NLkJSoCgGBWBMAQMCoB8THUxVQ0FTIEVEVUFSRE8gREUgU09VWkEgUE9MRVpBoBkGBWBMAQMDoBATDjExNzI2NzU' +
    '2MDAwMTM5oDgGBWBMAQMEoC8TLTA0MDgxOTk4MDA3MzUwMTU5MDIwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMKAXBgVgTAEDB6AOEwwwMDAwMDAwMDAwMDAwHQYDVR0lBBYwFAYIKwYBBQUHAwIGCCsGAQUFBwMEMAkGA1UdEwQCMAAwDQYJKoZIhvcNAQELBQADggIBAD6imA0B3BGYtUwmFI/zj0LXwXiA90VLANgs+gMZesbc/o73T8+uG5dg4ThEDv0BFSZvgr0brNzoozdk4UPTTuXXdSaGhKQnoV/rxj+PLQR7ItRWZxLjtl8RVVjdJhMiroX9548AtVEYkRvPCCWGM3WrpRl/OUx8hEqzbXppve0oilAfJ6bqAblKtPftrMWllYlhmzzAnXk9QFx2/3FqKl490+g6g2R7cIYdeUaWXs0lezzGNe' +
    'tIde+yWnmisxfhEg8ky96UNByCH170rX6NWj/4tXLImnkZ/jZ94QfzQ9pv6cNq+XkWA028rrCLz9s7buQyhuDEkjEFgbB5AV3RltHT65Z5uTzUJkPXW+0M9NwgoAkyqF6aOOX/0CqjE12SUIw+Dwf7Cnk0aVrd6fCsu9UME/XoyfKlrNuekH5ctZpUoBdmt66DxOln5kwKLcwWgge6PwimABBTZ7TDt2Sq4VVfAoY+XH5LlQww9aXvEenCmpXQ5nA4UyXGzq6o+e+vwDuNQwTuObizz0VJk1IFPl1Lw5FXIwEv+90j78h5M09JPef3ehANYVktllTwCG8931zQUVSjX6BTErAj4yg4UrKryd83QhQboYnCLvgAxdWA8k+ueboF6nREOmmlT2Y8h6ctslKPOw/q97q0aofUpcxDayb2HjLPdji/5d9XEHFB';

     protNFeNode := nfeProcNode.AddChild('protNFe');
     protNFeNode.Attributes['versao'] := '4.00';

     infProtNode := protNFeNode.AddChild('infProt');

     if CBAmbiente.Text = 'Homologação' then
     infProtNode.AddChild('tpAmb').Text := '2'
     else if CBAmbiente.Text = 'Produção' then
     infProtNode.AddChild('tpAmb').Text := '1';

     infProtNode.AddChild('verAplic').text := 'SVRS2507041437DR';
     infProtNode.AddChild('chNFe').text := '42250711726756000139550010001388111301355478';
     infProtNode.AddChild('dhRecbto').text := FormatDateTime('yyyy"-"mm"-"dd"T"hh":"nn":"ss"-03:00"', ImpressaoNFEFormDataModule.TransmitirNotaQuery.FieldByName('dtemissao').AsDateTime);
     infProtNode.AddChild('nProt').text := '242250262909678';
     infProtNode.AddChild('digVal').text := 'CHPmn9OQGWW7Xzh8uDw9M94uY5U';
     infProtNode.AddChild('cStat').text := '100';
     infProtNode.AddChild('xMotivo').text := 'Autorizado o uso da NF-e';

    ImpressaoNFEFormDataModule.TransmitirNotaQuery.Next;
    ForceDirectories('C:\XML');
    XMLDoc.SaveToFile('C:\XML\notas.xml');
    ShowMessage('XML gerado com sucesso em C:\XML\notas.xml');
    except
    ShowMessage('Erro ao gerar XML!');
  end;
end;

procedure TImpressaoNFEForm.GridNotasCellClick(Column: TColumn);
var
  fatura, serie, emp_id: string;
begin
  fatura := GridNotas.DataSource.DataSet.FieldByName('fatura').AsString;
  serie := GridNotas.DataSource.DataSet.FieldByName('serie').AsString;
  emp_id := GridNotas.DataSource.DataSet.FieldByName('emp_id').AsString;

  ImpressaoNFEFormDataModule.SelectNotaItenQuery.SQL.Clear;
  ImpressaoNFEFormDataModule.SelectNotaItenQuery.Close;

  ImpressaoNFEFormDataModule.SelectNotaItenQuery.SQL.Text :=
    'SELECT ni.* FROM notaiten ni ' +
    'INNER JOIN nota n ON (ni.fatura = n.fatura) AND (n.id = ni.id_nota) ' +
    'WHERE n.fatura = :fatura ' +
    'AND n.serie = :serie ' +
    'AND n.emp_id = :emp_id';

  ImpressaoNFEFormDataModule.SelectNotaItenQuery.ParamByName('fatura').AsString := fatura;
  ImpressaoNFEFormDataModule.SelectNotaItenQuery.ParamByName('serie').AsString := serie;
  ImpressaoNFEFormDataModule.SelectNotaItenQuery.ParamByName('emp_id').AsString := emp_id;
  ImpressaoNFEFormDataModule.SelectNotaItenQuery.Open;
end;

procedure TImpressaoNFEForm.SBEntidadeClick(Sender: TObject);
var entidade, codigo: string;
begin
 CadEntidadeDataModule.FDQuery1.Close;
 CadEntidadeDataModule.FDQuery1.Open;
 Application.CreateForm(TConsultarEntidade, ConsultarEntidade);

 codigo := ConsultarEntidade.SelecionarEntidade;

 Entidade := ConsultarEntidade.nome;
 EdtEntidade.Text := entidade;
end;

procedure TImpressaoNFEForm.SBFaturaClick(Sender: TObject);
var fatura: string;
begin
  ImpressaoNFEFormDataModule.ConsultarFaturaQuery.Close;
  ImpressaoNFEFormDataModule.ConsultarFaturaQuery.Open;
  Application.CreateForm(TConsultarFatura, ConsultarFatura);

  fatura := ConsultarFatura.SelecionarFatura;
  EdtFatura.Text := fatura;
end;

procedure TImpressaoNFEForm.SBNaturezaClick(Sender: TObject);
var natureza: string;
begin
  CadNaturezaDataModule.QueryNaturezas.Close;
  CadNaturezaDataModule.QueryNaturezas.Open;
  Application.CreateForm(TConsultarNatureza, ConsultarNatureza);

  natureza := ConsultarNatureza.SelecionarNatureza;
  EdtNatureza.Text := natureza;
end;

end.
