unit EditorSQL;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.ExtCtrls, Vcl.StdCtrls, Data.DB, Vcl.Grids, Vcl.DBGrids, Vcl.ComCtrls,
  EditorSQLDataModule,
  Log, LogDataModule,
  GlobalUnit;

type
  TEditorSQLForm = class(TForm)
    Panel1: TPanel;
    EdtSQL: TEdit;
    btnExecutar: TButton;
    btnConsultar: TButton;
    Grid: TDBGrid;
    GridTables: TDBGrid;
    btnFechar: TButton;
    procedure btnConsultarClick(Sender: TObject);
    procedure btnExecutarClick(Sender: TObject);
    procedure btnFecharClick(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
  end;

var
  EditorSQLForm: TEditorSQLForm;

implementation

{$R *.dfm}

uses MenuPrincipal;

procedure TEditorSQLForm.btnConsultarClick(Sender: TObject);
var SQL, tela: string;
    i: Integer;
    data: tdatetime;
begin
 tela := 'EditorSQL';
 SQL := EdtSQL.Text;
 data := now;

 EditorSQLModule.FDQuery1.SQL.Clear;
 EditorSQLModule.FDQuery1.Close;
 EditorSQLModule.FDQuery1.SQL.Text := EdtSQL.Text;
 EditorSQLModule.FDQuery1.Open;

 for i := 0 to Grid.Columns.Count - 1 do
 Grid.Columns[i].Width := Grid.Canvas.TextWidth(Grid.Columns[i].Title.Caption + '     ');

 LogModule.InserirLog.SQL.Clear;
 LogModule.InserirLog.SQL.Text :=
 'insert into logs (descricao, tela, data, emp_id, usuario) values (:descricao, :tela, :data, :emp_id, :usuario)';
 LogModule.InserirLog.ParamByName('descricao').AsString :=
 'Fez o select ' + SQL;
 LogModule.InserirLog.ParamByName('tela').AsString := tela;
 LogModule.InserirLog.ParamByName('data').AsDatetime := Data;
 LogModule.InserirLog.ParamByName('usuario').AsString := UsuarioLogado;
 LogModule.InserirLog.ParamByName('emp_id').AsString := EmpresaLogada;
 LogModule.InserirLog.ExecSQL;

 EditorSQLModule.TablesBanco.Close;
 EditorSQLModule.TablesBanco.Open;
end;

procedure TEditorSQLForm.btnExecutarClick(Sender: TObject);
var SQL, tela: string;
    i: Integer;
    data: tdatetime;
begin
 tela := 'EditorSQL';
 SQL := EdtSQL.Text;
 data := now;

 EditorSQLModule.FDQuery1.SQL.Clear;
 EditorSQLModule.FDQuery1.SQL.Text := EdtSQL.Text;

 LogModule.InserirLog.SQL.Clear;
 LogModule.InserirLog.SQL.Text :=
 'insert into logs (descricao, tela, data, emp_id, usuario) values (:descricao, :tela, :data, :emp_id, :usuario)';
 LogModule.InserirLog.ParamByName('descricao').AsString :=
 'Rodou o comando ' + SQL;
 LogModule.InserirLog.ParamByName('tela').AsString := tela;
 LogModule.InserirLog.ParamByName('data').AsDatetime := Data;
 LogModule.InserirLog.ParamByName('usuario').AsString := UsuarioLogado;
 LogModule.InserirLog.ParamByName('emp_id').AsString := EmpresaLogada;
 try
 EditorSQLModule.FDQuery1.ExecSQL;
 LogModule.InserirLog.ExecSQL;
 showmessage('Executado com sucesso!');
 except
 showmessage('Erro no SQL, verifique!');
 end;

  for i := 0 to Grid.Columns.Count - 1 do
    Grid.Columns[i].Width := Grid.Canvas.TextWidth(Grid.Columns[i].Title.Caption + '     ');

    EditorSQLModule.TablesBanco.Close;
    EditorSQLModule.TablesBanco.Open;
end;

procedure TEditorSQLForm.btnFecharClick(Sender: TObject);
  begin
    (Parent as TTabSheet).PageControl := nil;
    Parent.Free;

    EditorSQLModule.TablesBanco.Close;
    EditorSQLModule.TablesBanco.Open;
  end;
end.
