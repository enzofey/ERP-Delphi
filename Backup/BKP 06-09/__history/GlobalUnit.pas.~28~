unit GlobalUnit;

interface

var UsuarioLogado: String;
var EmpresaLogada: String;
procedure FecharTela(Sender: TObject);

implementation

Uses System.SysUtils, Vcl.ComCtrls, Vcl.Controls, Vcl.Forms;

procedure FecharTela(Sender: TObject);
var
  Ctrl: TControl;
  Tab: TTabSheet;
  Page: TPageControl;
  Frm: TForm;
begin
  if not (Sender is TControl) then
    Exit;

  Ctrl := TControl(Sender);

  while Assigned(Ctrl) do
  begin
    // 1. Se estiver dentro de uma aba -> fecha só a aba
    if Ctrl is TTabSheet then
    begin
      Tab := TTabSheet(Ctrl);
      Page := Tab.PageControl;

      Tab.Free;

      // 2. Se o PageControl não tiver mais abas -> fecha o próprio PageControl
      if Assigned(Page) and (Page.PageCount = 0) then
      begin
        Page.Free;

        // 3. Se o dono do PageControl for um Form e não for o MainForm -> fecha o Form
        if (Page.Owner is TForm) then
        begin
          Frm := TForm(Page.Owner);
          if Frm <> Application.MainForm then
            Frm.Close;
        end;
      end;

      Exit;
    end;

    Ctrl := Ctrl.Parent;
  end;

  // 4. Se não achou aba nem PageControl, fecha o Form (se não for o principal)
  if (Ctrl is TForm) then
  begin
    Frm := TForm(Ctrl);
    if Frm <> Application.MainForm then
      Frm.Close;
  end;
end;
end.
