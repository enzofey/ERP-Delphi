unit RelMovto;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.ExtCtrls, Data.DB, Vcl.StdCtrls, Vcl.ComCtrls,
  Vcl.Grids, Vcl.DBGrids, Vcl.Buttons,
  RelMovtoFormDM,
  CorDM, ConsultarCorForm,
  DepositoDM, ConsultarDepositoForm,
  ProdutoDM, ConsultarProdutoForm,
  TamanhoDM, ConsultarTamanhoForm;

type
  TRelMovtoForm = class(TForm)
    Panel1: TPanel;
    lblCodigo: TLabel;
    lblCor: TLabel;
    lblDeposito: TLabel;
    lblTamanho: TLabel;
    SBProduto: TSpeedButton;
    SBCor: TSpeedButton;
    SBDeposito: TSpeedButton;
    SBTamanho: TSpeedButton;
    SBApagarProduto: TSpeedButton;
    SBApagarCor: TSpeedButton;
    SBApagarDeposito: TSpeedButton;
    SBApagarTamanho: TSpeedButton;
    Grid: TDBGrid;
    EdtProduto: TEdit;
    EdtCor: TEdit;
    EdtDeposito: TEdit;
    EdtTamanho: TEdit;
    btnConsultar: TButton;
    btnFechar: TButton;
    RGTipo: TRadioGroup;
    RBEntrada: TRadioButton;
    RBSaida: TRadioButton;
    RBAmbos: TRadioButton;
    lblEstornarMovimento: TLabel;
    lblMovimento: TLabel;
    edtID: TEdit;
    btnEstornar: TButton;
    procedure SBProdutoClick(Sender: TObject);
    procedure SBCorClick(Sender: TObject);
    procedure SBDepositoClick(Sender: TObject);
    procedure SBTamanhoClick(Sender: TObject);
    procedure btnFecharClick(Sender: TObject);
    procedure SBApagarProdutoClick(Sender: TObject);
    procedure SBApagarCorClick(Sender: TObject);
    procedure SBApagarDepositoClick(Sender: TObject);
    procedure SBApagarTamanhoClick(Sender: TObject);
    procedure btnConsultarClick(Sender: TObject);
    procedure btnEstornarClick(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
  end;

var
  RelMovtoForm: TRelMovtoForm;

implementation

{$R *.dfm}

Uses MenuPrincipal, GlobalUnit;

procedure TRelMovtoForm.btnConsultarClick(Sender: TObject);
var texto, codigo, cor, tamanho, deposito, tipo: string;
    temwhere: boolean;
    I :integer;
begin
  codigo := EdtProduto.Text;
  cor := EdtCor.Text;
  Tamanho := EdtTamanho.Text;
  Deposito := EdtDeposito.Text;
  if RBEntrada.Checked then Tipo := 'E'
  else if RBSaida.Checked then Tipo := 'S'
  else if RBAmbos.Checked then Tipo := '';

  RelMovtoDM.ConsultarProdMov.SQL.Clear;
  RelMovtoDM.ConsultarProdMov.SQL.Text :=
  'select pm.id, pm.codigo, pm.cor, pm.tamanho, pm.deposito, pm.lote, pm.qtde, pm.data, pm.tipo, pm.usuario, CAST(pm.obs AS VARCHAR(255)) as Observação from prodmov pm ' +
  'inner join cadproduto cp on (cp.codigo = pm.codigo) ' +
  'inner join cadcor cc on (cc.descricao = pm.cor) ' +
  'inner join cadtamanho ct on (ct.codigo = pm.tamanho) ' +
   'inner join caddeposito cd on (cd.codigo = pm.deposito) ';
  temwhere := False;

  if codigo <> '' then
  begin
  if temwhere then begin
  RelMovtoDM.ConsultarProdMov.SQL.Add('and cp.codigo = :codigo');
  RelMovtoDM.ConsultarProdMov.ParamByName('codigo').AsString := codigo;
  end
  else begin
  RelMovtoDM.ConsultarProdMov.SQL.Add('where cp.codigo = :codigo');
  RelMovtoDM.ConsultarProdMov.ParamByName('codigo').AsString := codigo;
  end;
end;
  temwhere := true;

  if cor <> '' then
  begin
   if temwhere then begin
  RelMovtoDM.ConsultarProdMov.SQL.Add('and cc.codigo = :cor');
  RelMovtoDM.ConsultarProdMov.ParamByName('cor').AsString := cor;
  end
  else begin
  RelMovtoDM.ConsultarProdMov.SQL.Add('where cc.codigo = :cor');
  RelMovtoDM.ConsultarProdMov.ParamByName('cor').AsString := cor;
  end;
  end;
  temwhere := True;

  if deposito <> '' then
  begin
   if temwhere then begin
  RelMovtoDM.ConsultarProdMov.SQL.Add('and cd.codigo = :deposito');
  RelMovtoDM.ConsultarProdMov.ParamByName('deposito').AsString := deposito;
  end
  else begin
  RelMovtoDM.ConsultarProdMov.SQL.Add('where cd.codigo = :deposito');
  RelMovtoDM.ConsultarProdMov.ParamByName('deposito').AsString := deposito;
  end;
  end;
  temwhere := True;

  if tamanho <> '' then
  begin
   if temwhere then begin
  RelMovtoDM.ConsultarProdMov.SQL.Add('and ct.codigo = :tamanho');
  RelMovtoDM.ConsultarProdMov.ParamByName('tamanho').AsString := tamanho;
  end
  else begin
  RelMovtoDM.ConsultarProdMov.SQL.Add('where ct.codigo = :tamanho');
  RelMovtoDM.ConsultarProdMov.ParamByName('tamanho').AsString := tamanho;
  end;
  end;
  temwhere := True;

  if tipo = 'S' then
  begin
   if temwhere then begin
  RelMovtoDM.ConsultarProdMov.SQL.Add('and pm.tipo = :tipo');
  RelMovtoDM.ConsultarProdMov.ParamByName('tipo').AsString := tipo;
  end
  else begin
  RelMovtoDM.ConsultarProdMov.SQL.Add('where pm.tipo = :tipo');
  RelMovtoDM.ConsultarProdMov.ParamByName('tipo').AsString := tipo;
  end;
  end;
  temwhere := True;

  if tipo = 'E' then
  begin
   if temwhere then begin
  RelMovtoDM.ConsultarProdMov.SQL.Add('and pm.tipo = :tipo');
  RelMovtoDM.ConsultarProdMov.ParamByName('tipo').AsString := tipo;
  end
  else begin
  RelMovtoDM.ConsultarProdMov.SQL.Add('where pm.tipo = :tipo');
  RelMovtoDM.ConsultarProdMov.ParamByName('tipo').AsString := tipo;
  end;
  end;
  temwhere := True;

  if not RBEntrada.Checked and not RBSaida.Checked and not RBAmbos.Checked then begin
  ShowMessage('Tipo do movimento não selecionado!')
  end
  else begin
  RelMovtoDM.ConsultarProdMov.Open;
    for i := 0 to Grid.Columns.Count - 1 do
  begin
    texto := Grid.Columns[i].Title.Caption;

    if Length(Grid.DataSource.DataSet.Fields[i].AsString) > Length(texto) then
      texto := Grid.DataSource.DataSet.Fields[i].AsString;

    Grid.Columns[i].Width := Grid.Canvas.TextWidth(texto + '    ');
  end;
  end;
end;

procedure TRelMovtoForm.btnFecharClick(Sender: TObject);
begin
 Fechartela(sender);
end;

procedure TRelMovtoForm.SBCorClick(Sender: TObject);
var cor: string;
begin
  CadCorDM.ConsultarCor.SQL.Clear;
  CadCorDM.ConsultarCor.SQL.Text :=
  'select * from cadcor';
  CadCorDM.ConsultarCor.Open;

  Application.CreateForm(TConsultarCor, ConsultarCor);
  cor := ConsultarCor.SelecionarCor;
  if cor <> '' then
  begin
    EdtCor.Text := cor;
  end;
end;

procedure TRelMovtoForm.SBDepositoClick(Sender: TObject);
var codigo: string;
begin
  CadDepositoDM.ConsultarDeposito.SQL.Clear;
  CadDepositoDM.ConsultarDeposito.SQL.Text :=
  'select * from caddeposito';
  CadDepositoDM.ConsultarDeposito.Open;

  Application.CreateForm(TConsultarDeposito, ConsultarDeposito);
  codigo := ConsultarDeposito.SelecionarDeposito;
  if codigo <> '' then
  begin
    EdtDeposito.Text := codigo;
  end;
end;

procedure TRelMovtoForm.SBProdutoClick(Sender: TObject);
var codigo: string;
begin
  CadProdutoDM.ConsultarProduto.SQL.Clear;
  CadProdutoDM.ConsultarProduto.SQL.Text :=
  'select * from cadproduto';
  CadProdutoDM.ConsultarProduto.Open;

  Application.CreateForm(TConsultarProduto, ConsultarProduto);
  codigo := ConsultarProduto.SelecionarProduto;
  if codigo <> '' then
  begin
    EdtProduto.Text := codigo;
  end;
end;

procedure TRelMovtoForm.SBTamanhoClick(Sender: TObject);
var codigo: string;
begin
  CadTamanhoDM.ConsultarTamanho.SQL.Clear;
  CadTamanhoDM.ConsultarTamanho.SQL.Text :=
  'select * from cadtamanho';
  CadTamanhoDM.ConsultarTamanho.Open;

  Application.CreateForm(TConsultarTamanho, ConsultarTamanho);
  codigo := ConsultarTamanho.SelecionarTamanho;
  if codigo <> '' then
  begin
    EdtTamanho.Text := codigo;
  end;
end;

procedure TRelMovtoForm.SBApagarCorClick(Sender: TObject);
begin
 EdtCor.Clear;
end;

procedure TRelMovtoForm.SBApagarDepositoClick(Sender: TObject);
begin
 EdtDeposito.Clear;
end;

procedure TRelMovtoForm.SBApagarProdutoClick(Sender: TObject);
begin
 EdtProduto.Clear;
end;

procedure TRelMovtoForm.SBApagarTamanhoClick(Sender: TObject);
begin
 EdtTamanho.Clear;
end;

procedure TRelMovtoForm.btnEstornarClick(Sender: TObject);
var ID, codigo, cor, tamanho, deposito, lote, qtde, tipo: string;
begin
  ID := EdtID.Text;

  if MessageDlg('Deseja continuar com o estorno? Essa ação é irreversível! Na dúvida, faça apenas uma entrada ou saída no código desejado!',
    mtConfirmation, [mbYes, mbNo], 0) = mrNo then
  begin
    Exit;
  end;

  RelMovtoDM.IDQuery.Close;
  RelMovtoDM.IDQuery.SQL.Text :=
  'select ID, codigo, cor, tamanho, deposito, lote, qtde, tipo from prodmov where id = :ID';
  RelMovtoDM.IDQuery.ParamByName('ID').AsString := ID;
  RelMovtoDM.IDQuery.Open;

  if RelMovtoDM.IDQuery.IsEmpty then begin
  ShowMessage('ID do movimento não encontrado');
  Exit;
  end;

  codigo := RelMovtoDM.IDQuery.FieldByName('codigo').AsString;
  cor := RelMovtoDM.IDQuery.FieldByName('cor').AsString;
  tamanho := RelMovtoDM.IDQuery.FieldByName('tamanho').AsString;
  deposito := RelMovtoDM.IDQuery.FieldByName('deposito').AsString;
  lote := RelMovtoDM.IDQuery.FieldByName('lote').AsString;
  qtde := RelMovtoDM.IDQuery.FieldByName('qtde').AsString;
  tipo := RelMovtoDM.IDQuery.FieldByName('tipo').AsString;

  RelMovtoDM.Conexão.StartTransaction;
  try
  RelMovtoDM.EstornarQuery.Close;
  RelMovtoDM.EstornarQuery.SQL.Text := 'delete from prodmov where id = :ID';
  RelMovtoDM.EstornarQuery.ParamByName('ID').AsString := ID;
  RelMovtoDM.EstornarQuery.ExecSQL;

  if tipo = 'E' then
  RelMovtoDM.EstornarQuery.SQL.Text :=
  'update estoque set qtde = qtde - :qtde ' +
  'where codigo = :codigo and cor = :cor and tamanho = :tamanho and deposito = :deposito and lote = :lote'
  else if tipo = 'S' then
  RelMovtoDM.EstornarQuery.SQL.Text :=
  'update estoque set qtde = qtde + :qtde ' +
  'where codigo = :codigo and cor = :cor and tamanho = :tamanho and deposito = :deposito and lote = :lote';

  RelMovtoDM.EstornarQuery.ParamByName('qtde').AsInteger := StrToInt(qtde);
  RelMovtoDM.EstornarQuery.ParamByName('codigo').AsString := codigo;
  RelMovtoDM.EstornarQuery.ParamByName('cor').AsString := cor;
  RelMovtoDM.EstornarQuery.ParamByName('tamanho').AsString := tamanho;
  RelMovtoDM.EstornarQuery.ParamByName('deposito').AsString := deposito;
  RelMovtoDM.EstornarQuery.ParamByName('lote').AsString := lote;
  RelMovtoDM.EstornarQuery.ExecSQL;

  RelMovtoDM.Conexão.Commit;
  ShowMessage('Estornado com sucesso!');
  EdtID.Clear;
  except
  RelMovtoDM.Conexão.Rollback;
  ShowMessage('Erro no estorno!');
  end;
  end;
end.
